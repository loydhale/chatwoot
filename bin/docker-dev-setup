#!/usr/bin/env bash
#
# DeskFlows Docker Dev Environment â€” One-command setup
# Usage: ./bin/docker-dev-setup [--reset]
#
# Builds images, starts services, prepares the database.
# Pass --reset to nuke volumes and start fresh.
#
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

step() { echo -e "\n${CYAN}â–¸ $1${NC}"; }
ok()   { echo -e "${GREEN}âœ“ $1${NC}"; }
warn() { echo -e "${YELLOW}âš  $1${NC}"; }
fail() { echo -e "${RED}âœ— $1${NC}"; exit 1; }

# ------------------------------------------------------------------
# Preflight
# ------------------------------------------------------------------
step "Checking prerequisites..."

if ! command -v docker &>/dev/null; then
  fail "Docker not found. Install Docker Desktop or OrbStack first."
fi

if ! docker compose version &>/dev/null; then
  fail "Docker Compose v2 not found. Upgrade Docker."
fi

# Verify the daemon is actually responding
if ! docker info &>/dev/null 2>&1; then
  fail "Docker daemon not responding. Start Docker Desktop / OrbStack and try again."
fi

ok "Docker $(docker --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+') + Compose $(docker compose version --short)"

# ------------------------------------------------------------------
# Handle --reset
# ------------------------------------------------------------------
if [[ "${1:-}" == "--reset" ]]; then
  step "Resetting: stopping services and removing volumes..."
  docker compose down -v 2>/dev/null || true
  ok "Volumes removed"
fi

# ------------------------------------------------------------------
# Environment file
# ------------------------------------------------------------------
step "Checking environment files..."

if [[ ! -f .env ]]; then
  if [[ -f .env.example ]]; then
    cp .env.example .env
    ok "Created .env from .env.example"
  else
    fail ".env.example not found â€” cannot create .env"
  fi
else
  ok ".env already exists"
fi

if [[ ! -f .env.docker ]]; then
  fail ".env.docker is missing â€” this file is required for Docker"
fi
ok ".env.docker present"

# ------------------------------------------------------------------
# Build images
# ------------------------------------------------------------------
step "Building base image (this takes a while the first time)..."
docker compose build base
ok "Base image built"

step "Building rails and vite images..."
docker compose build rails vite
ok "App images built"

# ------------------------------------------------------------------
# Start services
# ------------------------------------------------------------------
step "Starting all services..."
docker compose up -d
ok "Services started"

# ------------------------------------------------------------------
# Wait for health checks
# ------------------------------------------------------------------
step "Waiting for postgres to be healthy..."
retries=0
max_retries=30
until docker compose exec -T postgres pg_isready -U postgres &>/dev/null; do
  retries=$((retries + 1))
  if [[ $retries -ge $max_retries ]]; then
    fail "Postgres did not become ready in time. Check: docker compose logs postgres"
  fi
  sleep 2
done
ok "Postgres is ready"

step "Waiting for redis to be healthy..."
retries=0
until docker compose exec -T redis redis-cli -a redis ping 2>/dev/null | grep -q PONG; do
  retries=$((retries + 1))
  if [[ $retries -ge $max_retries ]]; then
    fail "Redis did not become ready in time. Check: docker compose logs redis"
  fi
  sleep 2
done
ok "Redis is ready"

# ------------------------------------------------------------------
# Database setup
# ------------------------------------------------------------------
step "Preparing database (db:deskflows_prepare)..."
docker compose exec -T rails bundle exec rails db:deskflows_prepare
ok "Database ready"

# ------------------------------------------------------------------
# Done
# ------------------------------------------------------------------
echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}  DeskFlows is running! ğŸš€${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "  App:      ${CYAN}http://localhost:3000${NC}"
echo -e "  Vite:     ${CYAN}http://localhost:3036${NC}"
echo -e "  Mailhog:  ${CYAN}http://localhost:8025${NC}"
echo -e "  Postgres:  localhost:5432  (user: postgres / pass: postgres)"
echo -e "  Redis:     localhost:6379  (pass: redis)"
echo ""
echo -e "  Logs:     ${YELLOW}docker compose logs -f${NC}"
echo -e "  Console:  ${YELLOW}docker compose exec rails bundle exec rails console${NC}"
echo -e "  Stop:     ${YELLOW}docker compose down${NC}"
echo ""
