#!/usr/bin/env bash
# Local development setup script for DeskFlow
set -e

echo "üîß DeskFlow Local Development Setup"
echo "===================================="

# Check for required tools
command -v rbenv >/dev/null 2>&1 || { echo "‚ùå rbenv is required. Install with: brew install rbenv"; exit 1; }
command -v pnpm >/dev/null 2>&1 || { echo "‚ùå pnpm is required. Install with: brew install pnpm"; exit 1; }
command -v psql >/dev/null 2>&1 || { echo "‚ùå PostgreSQL is required. Install with: brew install postgresql@17"; exit 1; }
command -v redis-cli >/dev/null 2>&1 || { echo "‚ùå Redis is required. Install with: brew install redis"; exit 1; }

# Initialize rbenv
eval "$(rbenv init -)"

# Check Ruby version
REQUIRED_RUBY=$(cat .ruby-version)
CURRENT_RUBY=$(ruby -v | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)

if [[ "$CURRENT_RUBY" != "$REQUIRED_RUBY" ]]; then
  echo "üì¶ Installing Ruby $REQUIRED_RUBY..."
  rbenv install "$REQUIRED_RUBY" --skip-existing
  rbenv local "$REQUIRED_RUBY"
  eval "$(rbenv init -)"
fi

echo "‚úÖ Ruby $(ruby -v | head -1)"

# Install bundler and gems
echo "üì¶ Installing Ruby dependencies..."
gem install bundler --no-document
bundle install

# Install Node dependencies
echo "üì¶ Installing Node dependencies..."
pnpm install

# Start services
echo "üöÄ Starting PostgreSQL and Redis..."
brew services start postgresql@17 2>/dev/null || brew services start postgresql 2>/dev/null || true
brew services start redis 2>/dev/null || true
sleep 2

# Check pgvector
if ! psql -d postgres -c "SELECT 1 FROM pg_available_extensions WHERE name = 'vector'" | grep -q 1; then
  echo "üì¶ Installing pgvector..."
  brew install pgvector
fi

# Setup .env if needed
if [ ! -f .env ]; then
  echo "üìù Creating .env from template..."
  cp .env.example .env
  # Update for local development
  sed -i '' 's/POSTGRES_HOST=postgres/POSTGRES_HOST=localhost/g' .env
  sed -i '' 's/POSTGRES_USERNAME=postgres/POSTGRES_USERNAME='$(whoami)'/g' .env
  sed -i '' 's|REDIS_URL=redis://redis:6379|REDIS_URL=redis://localhost:6379|g' .env
fi

# Setup database
echo "üóÑÔ∏è  Setting up database..."
bin/rails db:prepare

echo ""
echo "‚úÖ Setup complete! Run the app with:"
echo "   bin/dev"
echo ""
echo "Or just the Rails server:"
echo "   bin/rails s"
